\documentclass[discrete.tex]{subfiles}

\begin{document}
  \section{Поиск образца в строке (Карпа-Рабина, Бойера-Мура)}

  \begin{definition}
    Пусть заданы две строки: t (text) и p (pattern). Говорят, что образец входит точно в текст с позиции j, если $t[j:j+m-1] = p[1:m]$
  \end{definition}

  Наивный метод: ходим по строке, ищем первый символ, затем второй... Сложность $m \cdot n$

  \begin{definition}
    Пусть задана числовая последовательность $p_1,...,p_n$, определим скользящую сумму как $s_i=p_i+p_{i+1}+...+p_{r+i}$, где r - некоторое фиксированное число
  \end{definition}

  \begin{remark}
    Нетрудно заметить, что $s_{k+1} = s_k - p_k + p_{k+r}$
  \end{remark}

  \begin{remark}
    Аналогично можно считать полиномы $\sigma_k(x) = \sum_{i \in 0 : r-1} p_{k+i} x^{r-1-i}$, аналогично $\sigma_{k+1} = x \sigma_k - p_k x^r + p_{k+r}$. Эта функция быстро становится большой из-за x и r, но можно счиаить $p_k(x)$ как остаток отделения $\sigma_k$ на $d$. Тогда $p_{k+1} = (x \sigma_k - p_k R(x,r) + p_{k+r}) \mod d$, где $R(x,r) = x^r \mod d$
  \end{remark}

  \begin{alg}[метод Карпа-Раббина]
    Выберем подходящие x и d, вычислить $\sigma$ для строки длины m и для всех подстрок изначальной строки длины m и сравнить.
  \end{alg}

  \begin{alg}[метод Бойера-Мура]
    Сравнение начинается с последнего символа образца, который совмещается с началом. Если совпал $\Ra$ нашли. Если нет, пользуемся эвристиками:
    \begin{enumerate}
      \item Эвристика стоп-символа.
      \begin{enumerate}
        \item Если не совпало и текущего символа нет в строке, то следующую проверку можно сдвинуть на длину образа\\
        $\begin{matrix}
          \text{строка:} & . & . & . & . & . & . & \fbox{\text{П}} & . \q . \q . \q . \q . \q . \q .\\
          \text{шаблон:} & \text{К} & \text{О} & \text{Л} & \text{О} & \text{К} & \text{О} & \fbox{\text{Л}} & & \\
          \text{next step:} & & & & & & & & \ \text{К} \ \ \text{О}\ \ \text{Л}\ \ \text{О}\ \ \text{К}\ \ \text{О}\ \ \text{Л}
        \end{matrix}$
        \item Если такой символ есть, сдвигаемся до последнего вхождения в образце\\
          $\begin{matrix}
          \text{строка:} & . & . & . & . & . & . & \fbox{\text{К}} & . & .\\
          \text{шаблон:} & \text{К} & \text{О} & \text{Л} & \text{О} & \fbox{\text{К}} & \text{О} & \text{Л}\\
          \text{next step:} & & & \text{К} & \text{О} & \text{Л} & \text{О} & \fbox{\text{К}} & \text{О} & \text{Л}
          \end{matrix}$
      \end{enumerate}
      \item Правило хорошего окончания\\
      $\begin{matrix}
        \q &\text{строка:} & ... & \text{К} & \text{КОЛ} & ...\\
        &\text{шаблон:} & \text{КОЛ} & \text{О} & \text{КОЛ}\\
        &\text{next step:} & & & \text{КОЛ} & \text{ОЛОКОЛ}
      \end{matrix}$\\
      Пример для суффиксов и сдвигов: $\clock - 1,\ \text{Л} - 4,\ \text{ОЛ} - 4,\ \text{КОЛ} - 4$
    \end{enumerate}
  \end{alg}

  \begin{aalg}[Кнута-Морриса-Пратта]
    $\forall i \in 2: l=m+n+1$ вычислить:
    \begin{enumerate}
      \item $z_i$ - наибольшее k т.ч. $p[1:k] = p[i:(i+k-1)]$
      \item $r_i$ - наибольшее l т.ч. $\e b \leq i: p[b:e]$ совпадает с $p[1:(e-b+1)]$
      \item $l_i$ - какое-либо b из определения $r_i$
    \end{enumerate}
    Определяемая этими числами полстрока $p[l_i:r_i]$ совпадает с префиксом p и идет дальше всего по строке. По ней и определяется $z_i=l_i-0+1$

    Зная $z[2:i-1],\q L = l_{i-1}$ и $R=r_{i-1}$ мы можем вычислить $z_i$ и пересчитать L и R. Возможны несколько случаев. Если i>R, то подстрока, найденная для $i-1$, для i уже не годится и её нужно вычислить заново. Непосредственно сравниваем строки $p[i:m]$ и $p[1:m]$, находим длину совпадений части s и полагаем $z_i = s,\q L=l_i=i,\q R=r_i=i+s-1$

    Если $i \leq R$, то символ $p[i]$ лежит в подстроке $p[L:R]$, совпадающей с префиксом, и следовательно, $p[i:R]$ совпадает с суффиксом этого префикса. Длина суффикса равна $S=R-i+1$, а начальная позиция $i'=i-L+1$

    Если $z_{i'}<S$, то нужно принять $z_i=z_{i'}$, а L и R не изменятся

    Если $z_{i'}\geq S$, то вся подстрока $p[i:R]$ совпадает с префиксом. Возможно, что это совпадение идет и дальше, так что нужно продолжить, сравнивая строки $p[R+1:m]$ и $p[S+1:m]$. Установив совпадение вплоть до позиций $R+k$ и $S+k$, полагаем $L := i,\q R := R+k,\q z_i = k+1$
  \end{aalg}
\end{document}
